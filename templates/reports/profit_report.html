{% extends 'base.html' %}
{% load static %}

{% block title %}Báo cáo lợi nhuận - Kho Mỹ Phẩm{% endblock %}

{% block content %}
<div class="container py-4" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up">
    <div class="d-flex justify-content-between align-items-center mb-3" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
        <h2 class="mb-0"><i class="fas fa-chart-line brand-icon" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i><span class="brand-gradient"> Báo cáo lợi nhuận</span></h2>
        <a href="{% url 'reports:export_profit_excel' %}" class="btn btn-outline-success">
            <i class="fas fa-file-excel" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i> Xuất Excel
        </a>
    </div>

    <!-- Bộ lọc thời gian -->
    <div class="glass-card mb-4 glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
        <div class="glass-card-header glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
            <h5 class="mb-0"><i class="fas fa-filter" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i> Bộ lọc thời gian</h5>
        </div>
        <div class="glass-card-body glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
            <form method="get" class="row g-3 glass-form">
                <div class="col-md-4" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
                    <label for="start_date" class="form-label">Từ ngày</label>
                    <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date|default:'' }}">
                </div>
                <div class="col-md-4" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
                    <label for="end_date" class="form-label">Đến ngày</label>
                    <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date|default:'' }}">
                </div>
                <div class="col-md-4 d-flex align-items-end" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
                    <button type="submit" class="btn btn-modern me-2">
                        <i class="fas fa-search" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i> Lọc
                    </button>
                    <a href="{% url 'reports:profit_report' %}" class="btn btn-modern">
                        <i class="fas fa-times" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i> Xóa lọc
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Thống kê tổng quan -->
    <div class="row mb-4" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
        <div class="col-md-3" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
            <div class="glass-card mb-3 border border-primary" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
                <div class="glass-card-body text-center glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
                    <h4 class="glass-card-title text-primary">{{ total_import_value|floatformat:0 }}</h4>
                    <p class="glass-card-text text-muted">Tổng nhập (VNĐ)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
            <div class="glass-card mb-3 border border-success" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
                <div class="glass-card-body text-center glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
                    <h4 class="glass-card-title text-success">{{ total_export_value|floatformat:0 }}</h4>
                    <p class="glass-card-text text-muted">Tổng xuất (VNĐ)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
            <div class="glass-card text-bg-info mb-3 glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
                <div class="glass-card-body text-center glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
                    <h4 class="glass-card-title">{{ total_profit|floatformat:0 }}</h4>
                    <p class="glass-card-text">Tổng lợi nhuận (VNĐ)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
            <div class="glass-card text-bg-warning mb-3 glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
                <div class="glass-card-body text-center glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
                    <h4 class="glass-card-title">{{ profit_margin|floatformat:1 }}%</h4>
                    <p class="glass-card-text">Tỷ lệ lợi nhuận</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Biểu đồ lợi nhuận -->
    <div class="row mb-4" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
        <div class="col-md-6" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
            <div class="glass-card h-100 glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
                <div class="glass-card-header glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
                    <h5 class="mb-0"><i class="fas fa-chart-pie" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i> Phân bố lợi nhuận</h5>
                </div>
                <div class="glass-card-body glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
                    <canvas id="profitChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
            <div class="glass-card h-100 glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
                <div class="glass-card-header glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
                    <h5 class="mb-0"><i class="fas fa-chart-bar" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i> Top sản phẩm lợi nhuận cao</h5>
                </div>
                <div class="glass-card-body glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
                    <canvas id="topProfitChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Bảng chi tiết lợi nhuận -->
    <div class="glass-card glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
        <div class="glass-card-header glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
            <h5 class="mb-0"><i class="fas fa-table" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i> Chi tiết lợi nhuận theo sản phẩm</h5>
        </div>
        <div class="glass-card-body glass-card" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="slide-up" data-aos-delay="200">
            {% if profit_details %}
            <div class="table glass-table glass-table-responsive" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
                <table class="table glass-table glass-table table-striped table-hover glass-table">
                    <thead class="table glass-table glass-table-dark">
                        <tr data-aos="fade-in" data-aos-delay="500">
                            <th>STT</th>
                            <th>Sản phẩm</th>
                            <th>Danh mục</th>
                            <th>Số lượng xuất</th>
                            <th>Giá nhập TB</th>
                            <th>Giá xuất TB</th>
                            <th>Lợi nhuận/SP</th>
                            <th>Tổng lợi nhuận</th>
                            <th>Tỷ lệ LN</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in profit_details %}
                        <tr data-aos="fade-in" data-aos-delay="500">
                            <td>{{ forloop.counter }}</td>
                            <td>
                                <strong style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">{{ item.product.name }}</strong><br>
                                <small class="text-muted">{{ item.product.code }}</small>
                            </td>
                            <td>{{ item.product.category.name }}</td>
                            <td>{{ item.total_quantity }} {{ item.product.unit }}</td>
                            <td>{{ item.avg_import_price|floatformat:0 }} VNĐ</td>
                            <td>{{ item.avg_export_price|floatformat:0 }} VNĐ</td>
                            <td>
                                {% if item.profit_per_unit > 0 %}
                                    <span class="text-success fw-bold">+{{ item.profit_per_unit|floatformat:0 }} VNĐ</span>
                                {% else %}
                                    <span class="text-danger fw-bold">{{ item.profit_per_unit|floatformat:0 }} VNĐ</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.total_profit > 0 %}
                                    <span class="text-success fw-bold">+{{ item.total_profit|floatformat:0 }} VNĐ</span>
                                {% else %}
                                    <span class="text-danger fw-bold">{{ item.total_profit|floatformat:0 }} VNĐ</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.profit_margin > 0 %}
                                    <span class="badge badge-modern badge-modern badge-modern badge-normal">{{ item.profit_margin|floatformat:1 }}%</span>
                                {% else %}
                                    <span class="badge badge-modern badge-modern badge-modern badge-expired">{{ item.profit_margin|floatformat:1 }}%</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table glass-table glass-table-light">
                        <tr data-aos="fade-in" data-aos-delay="500">
                            <td colspan="7" class="text-end fw-bold">Tổng cộng:</td>
                            <td class="text-success fw-bold">
                                {% if total_profit > 0 %}
                                    +{{ total_profit|floatformat:0 }} VNĐ
                                {% else %}
                                    {{ total_profit|floatformat:0 }} VNĐ
                                {% endif %}
                            </td>
                            <td>
                                {% if profit_margin > 0 %}
                                    <span class="badge badge-modern badge-modern badge-modern badge-normal">{{ profit_margin|floatformat:1 }}%</span>
                                {% else %}
                                    <span class="badge badge-modern badge-modern badge-modern badge-expired">{{ profit_margin|floatformat:1 }}%</span>
                                {% endif %}
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="glass-alert alert alert-info glass-alert" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="fade-in" data-aos-delay="300">
                <i class="fas fa-info-circle" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i> Không có dữ liệu lợi nhuận trong khoảng thời gian này.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Thông tin bổ sung -->
    <div class="row mt-4" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
        <div class="col-md-6" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
            <div class="glass-alert alert alert-info glass-alert" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="fade-in" data-aos-delay="300">
                <strong style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Ghi chú:</strong> Lợi nhuận được tính từ chênh lệch giữa giá xuất và giá nhập trung bình của từng sản phẩm.
            </div>
        </div>
        <div class="col-md-6" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200">
            <div class="glass-alert alert alert-warning glass-alert" data-aos="fade-up" data-aos-delay="200" data-aos="fade-up" data-aos-delay="200" data-aos="fade-in" data-aos-delay="300">
                <strong style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Cảnh báo:</strong> Sản phẩm có lợi nhuận âm cần được xem xét lại chiến lược giá.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Dữ liệu cho biểu đồ
const profitData = {
    labels: ['Tổng nhập', 'Tổng xuất', 'Lợi nhuận'],
    datasets: [{
        data: [JSON.parse('{{ total_import_value|escapejs }}'), JSON.parse('{{ total_export_value|escapejs }}'), JSON.parse('{{ total_profit|escapejs }}')],
        backgroundColor: ['#dc3545', '#198754', '#0dcaf0'],
        borderWidth: 2
    }]
};

const topProfitData = {
    labels: JSON.parse('{{ top_products_labels|escapejs }}'),
    datasets: [{
        label: 'Lợi nhuận (VNĐ)',
        data: JSON.parse('{{ top_products_profits|escapejs }}'),
        backgroundColor: 'rgba(13, 202, 240, 0.5)',
        borderColor: 'rgba(13, 202, 240, 1)',
        borderWidth: 1
    }]
};

// Biểu đồ phân bố lợi nhuận
new Chart(document.getElementById('profitChart'), {
    type: 'doughnut',
    data: profitData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Biểu đồ top sản phẩm lợi nhuận cao
new Chart(document.getElementById('topProfitChart'), {
    type: 'bar',
    data: topProfitData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Tự động submit form khi thay đổi ngày
document.getElementById('start_date').addEventListener('change', function() {
    if (this.value && document.getElementById('end_date').value) {
        this.form.submit();
    }
});

document.getElementById('end_date').addEventListener('change', function() {
    if (this.value && document.getElementById('start_date').value) {
        this.form.submit();
    }
});
</script>
{% endblock %} 